# Ministry Deep Dive — Repeatable Task Guideline

This guideline documents the complete process for creating a **Ministry Deep Dive** section in the Docusaurus documentation site. It is designed so that Claude (or any contributor) can replicate this work consistently for any Sri Lankan ministry.

## Table of Contents

1. [Local Development Setup](#local-development-setup)
2. [The Idea](#the-idea)
3. [Research Phase](#research-phase)
4. [Data Model](#data-model)
5. [Implementation Checklist](#implementation-checklist)
6. [Component Reference](#component-reference)
7. [File Naming Conventions](#file-naming-conventions)
8. [Quality Checklist](#quality-checklist)

---

## Local Development Setup

Before starting a deep dive, ensure the local environment is ready. There are three services that power the full workflow.

### Prerequisites

**Python environment** — The backend CLI and API need a conda/mamba environment:

```bash
# Create from the environment file (only once)
/path/to/miniforge3/bin/mamba env create -f legislation/environment.yml --yes

# The environment name is "legislation" (defined in environment.yml)
```

**Node.js** — Both the Docusaurus site (`docs/`) and the React app (`legislation/ui/`) need Node 20+. Run `npm install` in each directory if `node_modules/` doesn't exist.

### The Three Services

| Service | Directory | Command | Default Port | Purpose |
|---------|-----------|---------|------|---------|
| **FastAPI Backend** | `legislation/` | `uvicorn pylegislation.research.api.main:app --host 0.0.0.0 --port 8000 --reload` | 8000 | Serves acts data from SQLite, proxies PDFs, runs AI analysis |
| **Next.js React App** | `legislation/ui/` | `npm run dev` | 3000 | Interactive acts browser, lineage editor, analysis UI |
| **Docusaurus Docs** | `docs/` | `npx docusaurus start --port 3001` | 3001 | Ministry deep dive documentation site |

**Important**: The React app fetches data from the backend at `http://localhost:8000`. The backend must be running for the `/acts` page to load.

### Database Migration

The SQLite database (`legislation/database/research.db`) must be seeded from `acts.json` before the backend API can serve data.

```bash
# Run from the legislation/ directory (important — find_project_root() uses environment.yml as a marker)
cd legislation
/path/to/miniforge3/envs/legislation/bin/legislation research migrate
```

**When to re-run migration:**
- After a fresh clone or after deleting `research.db`
- After updating `legislation/ui/public/data/acts.json` (e.g., adding new acts to the TSV and regenerating)
- The migration is idempotent — it skips acts that already exist in the database

**Common pitfall**: Running the migration from the repo root instead of `legislation/` causes `find_project_root()` to resolve to the wrong directory (it finds `.git` instead of `environment.yml`), and the migration fails with "JSON file not found".

### Data Pipeline: Which JSON Files to Update

The React app and the Docusaurus site use **different data files** generated by **different CLI commands**. Here's the complete map:

```
Canonical Source: legislation/reports/research/versions/v2_docs.tsv
    │
    ├─► CLI: legislation research process
    │   └─► legislation/ui/public/data/acts.json        ← React app acts browser
    │
    ├─► CLI: legislation research lineage
    │   └─► legislation/ui/public/data/lineage.json     ← React app lineage editor
    │
    ├─► CLI: legislation research migrate
    │   └─► legislation/database/research.db            ← Backend API (reads from SQLite)
    │
    └─► CLI: legislation research update-docs
        └─► docs/src/data/acts.json                     ← Docusaurus site (analyzed acts only)
```

**After adding new acts to the TSV**, run this sequence:

```bash
cd legislation

# 1. Regenerate the React app JSON files
legislation research process        # → ui/public/data/acts.json
legislation research lineage        # → ui/public/data/lineage.json

# 2. Re-seed the database so the API picks up new acts
legislation research migrate        # → database/research.db (idempotent)

# 3. (Optional) Update the Docusaurus acts list if analyses changed
legislation research update-docs    # → ../docs/src/data/acts.json
```

**After a deep-dive analysis** (creating a new `{act}-analysis.json`), you typically only need to update:
- `legislation/ui/public/data/lineage.json` — manually add amendment versions (see [React App Lineage Sync](#react-app-lineage-sync))
- `docs/src/data/` — the new analysis JSON + Docusaurus pages

### Quick Health Check

To verify everything is working:

```bash
# Backend API responds
curl -s http://localhost:8000/acts | python3 -c "import sys,json; print(len(json.load(sys.stdin)), 'acts')"

# React app is up
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000

# Docusaurus is up
curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/research/
```

---

## The Idea

Sri Lankan government gazettes assign specific Acts and Ordinances to each Minister. The **Ministry Deep Dive** creates an interactive, structured exploration of a ministry's entire legislative ecosystem — from a high-level catalog down to statutory body compositions and amendment histories.

### Why This Matters

- Acts don't exist in isolation. They cross-reference each other, share governance patterns, and evolve through amendments.
- A ministry-level view reveals the *shape* of governance: which domains are heavily legislated, which acts are outdated, where gaps exist.
- Structured data (not just prose) enables future graph-based exploration via OpenGIN.

### The Three Layers

```
Layer 1: Ministry Overview    → All acts under one minister, categorized by domain
Layer 2: Act Lineage          → Visual maps of amendments, cross-references, hierarchies
Layer 3: Act Deep Dive        → Statutory bodies, compositions, meetings, powers, gaps
```

Not every act needs Layer 3. Most will stay at Layer 1 (catalog) until researched. The `analysisDepth` field tracks this: `"catalog"` vs `"deep"`.

---

## Research Phase

Before any code, you need structured research. Here's what to gather for each ministry.

### Layer 1: Ministry Catalog (Required)

For each act assigned to the minister (from the gazette):

| Field | Source | Example |
|-------|--------|---------|
| Official title | Gazette / lawnet.gov.lk | "Health Services Act" |
| Act/Ordinance number | Gazette | "No. 12 of 1952" |
| Year | From the number | 1952 |
| Type | Act vs Ordinance | act |
| PDF or source URL | srilankalaw.lk, lawnet.gov.lk, etc. | https://... |
| Domain category | Your judgment based on subject matter | "Health Administration" |
| Brief summary | 1-2 sentences on what it does | "Establishes Health Council..." |
| Known amendments | From act text or secondary sources | [{actNumber, year}] |
| Cross-references | Other acts in this ministry it relates to | [act-id-1, act-id-2] |

**Domain categories** should be 4-8 groups that make sense for the ministry. Assign a distinct hex color to each.

### Layer 3: Act Deep Dive (When Available)

For acts with deep analysis, gather:

#### Statutory Bodies
- Name, establishing sections
- Current status (active / obsolete / unknown)
- Composition: ex-officio members, nominated members, max count, term length
- Meeting requirements: frequency, quorum, chairperson, reporting mechanism
- Powers / functions
- Data gaps: what you couldn't find

#### Amendments
- Amendment act number and year
- Type: Technical / Governance / Constitutional
- Specific sections amended
- Summary of changes
- Impact rating: high / medium / low
- Impact on meeting structures: none / medium / high

#### Governance Hierarchy
- Tiers established by the act
- Current replacement structure (if devolution or restructuring occurred)

#### Data Confidence
- Rate each category: high / medium / low
- Be honest about paywall barriers, missing records, unverified operational status

---

## Data Model

Two JSON files per ministry, stored in `docs/src/data/`.

### `ministry-{name}-ecosystem.json`

```json
{
  "ministry": {
    "name": "Ministry of ...",
    "gazetteReference": "Gazette Extraordinary No. .../...",
    "gazetteDate": "YYYY-MM-DD",
    "country": "Sri Lanka"
  },
  "domainCategories": [
    { "id": "slug", "label": "Display Name", "color": "#hex" }
  ],
  "acts": [
    {
      "id": "slug-name-number-year",
      "title": "Short Title",
      "number": "No. X of YYYY",
      "year": 0000,
      "kind": { "major": "Legislation", "minor": "act|ordinance" },
      "status": "active|repealed",
      "analysisDepth": "deep|catalog|none",
      "pdfUrl": "https://...",
      "domainCategory": "category-id",
      "summary": "1-2 sentence description",
      "crossReferences": ["other-act-id"],
      "amendments": [{ "actNumber": "No. X of YYYY", "year": 0000 }]
    }
  ]
}
```

### `{act-name}-analysis.json` (Only for deep-dive acts)

```json
{
  "act": { "id", "title", "number", "year", "kind" },
  "statutoryBodies": [{
    "id", "name",
    "kind": { "major": "Organisation", "minor": "statutory-body" },
    "sections", "currentStatus", "operationalStatus", "statusNote",
    "composition": { "maxMembers", "exOfficio": [], "nominated": [], "termLength", "reNomination" },
    "meetings": { "frequency", "convenedBy", "chairperson", "quorum", "location", "reporting", "dissentMechanism" },
    "powers": [],
    "dataGaps": []
  }],
  "amendments": [{
    "id", "actNumber", "year", "type", "sectionsAmended": [],
    "summary", "impactOnMeetings", "impactRating", "details"
  }],
  "timeline": [{ "year", "event", "type", "details" }],
  "governanceHierarchy": {
    "tiers": [{ "level", "name", "scope", "status", "relationship" }],
    "currentReplacement": { "national", "provincial", "regional", "local" }
  },
  "dataConfidence": { "legislativeFramework", "historicalDetails", "currentOperationalStatus" }
}
```

### OpenGIN `kind` Values

| Entity | major | minor |
|--------|-------|-------|
| Act | `Legislation` | `act` |
| Ordinance | `Legislation` | `ordinance` |
| Statutory Body | `Organisation` | `statutory-body` |

### ID Convention

IDs are slugified: `{short-title}-{number}-{year}` → `health-services-act-12-1952`

---

## Implementation Checklist

When adding a new ministry deep dive, follow this exact sequence:

### Phase 1: Data
- [ ] Create `docs/src/data/ministry-{name}-ecosystem.json`
- [ ] (If deep-dive acts exist) Create `docs/src/data/{act-name}-analysis.json`
- [ ] Validate JSON parses: `node -e "require('./docs/src/data/ministry-{name}-ecosystem.json')"`

### Phase 2: Pages
- [ ] Create `docs/docs/ministry-deep-dive/{ministry-slug}/` directory
  *Note: For the first ministry (health), pages live directly in `ministry-deep-dive/`. For subsequent ministries, create subdirectories.*
- [ ] Create `intro.md` — Section intro with OpenGIN mapping explainer
- [ ] Create `{ministry-slug}.mdx` — Imports `<MinistryOverview />` with data prop, includes Mermaid pie chart
- [ ] Create `act-lineage.md` — Mermaid diagrams: amendment flowchart, cross-references, governance hierarchy, ER diagram
- [ ] (If deep-dive acts exist) Create `{act-name}.mdx` — Imports deep-dive components
- [ ] Create `data-model.md` — JSON schema docs
- [ ] Update meetings registry — add new statutory body meeting rows to `docs/src/data/ministry-health-meetings.json`

### Phase 3: Sidebar
- [ ] Update `docs/sidebars.ts` — Add new category nested under Legislative Analysis > Ministry Deep Dive

### Phase 4: React App Lineage Sync
- [ ] (For each deep-dive act) Update `legislation/ui/public/data/lineage.json` — find the act's entry by `base_title` and add all amendment versions to its `versions` array
- [ ] (For each deep-dive act) If amendment rows are missing from `legislation/reports/research/versions/v2_docs.tsv`, add them following the Source Acquisition guideline

**Why this step matters:** The Docusaurus site and React legislation app are separate data stores. When a deep-dive analysis uncovers the complete amendment chain for an act, that data must be reflected in both places. The Docusaurus lineage pages (Mermaid diagrams) and the React app's `lineage.json` (interactive LineageView) must stay in sync.

### Phase 5: Verify
- [ ] `cd docs && npx docusaurus build` — zero errors
- [ ] All sidebar links resolve
- [ ] Mermaid diagrams render in light and dark mode
- [ ] Interactive components expand/collapse correctly
- [ ] No console errors
- [ ] React app lineage entries have correct version counts for deep-dive acts

---

## Meetings Registry

The **Meetings Registry** (`docs/docs/ministry-deep-dive/meetings.mdx`) is a centralized, searchable page that aggregates meeting data from all analyzed statutory bodies across all acts.

### How It Works

- Meeting data lives in `docs/src/data/ministry-health-meetings.json` — a flat array where each row is one statutory body's meeting requirements.
- The `MeetingsRegistry` component imports this JSON and renders a searchable, filterable table.
- When a new act is analyzed (Layer 3 deep dive), extract meeting data for each statutory body and add rows to the meetings JSON.

### Adding Meeting Records

For each statutory body found during a deep dive, add a record with these fields:

| Field | Description |
|-------|-------------|
| `body` | Statutory body name |
| `act` | Parent act short title |
| `actNumber` | e.g., "No. 12 of 1952" |
| `actYear` | Year as integer |
| `minister` | Responsible minister |
| `sections` | Establishing sections |
| `status` | `legally-active` or `obsolete` |
| `operationalStatus` | `active`, `unknown`, or `superseded` |
| `frequency` | Meeting frequency from legislation |
| `convenedBy` | Who convenes meetings |
| `chairperson` | Who chairs meetings |
| `quorum` | Quorum requirement |
| `reporting` | Reporting mechanism |
| `dissentMechanism` | How dissent is recorded |
| `maxMembers` | Max membership count or `null` |

Use `"Unknown"` for fields where data is unavailable. Use `"Not specified in Act"` when the legislation is silent.

---

## React App Lineage Sync

When a deep-dive analysis is completed for an act, the amendment data must be synced to the React legislation app so that the interactive LineageView shows the complete version chain.

### Where the data lives

| Store | File | Purpose |
|-------|------|---------|
| React app lineage | `legislation/ui/public/data/lineage.json` | Powers the interactive LineageView (search, timeline graph) |
| React app acts catalog | `legislation/ui/public/data/acts.json` | Powers the acts browser |
| Source catalog | `legislation/reports/research/versions/v2_docs.tsv` | Canonical document metadata, feeds lineage generation |
| Docusaurus lineage pages | `docs/docs/ministry-deep-dive/act-lineage/{act}/lineage.md` | Mermaid diagrams in the docs site |

### Sync procedure

For each deep-dive act, after creating the analysis JSON and Docusaurus lineage page:

1. **Find the act's entry in `lineage.json`** — search for its full title (e.g., `"Medical Ordinance, No. 26 of 1927"`). There may be two entries: one with a short `base_title` (auto-generated) and one with the full title (research-added). Update the **full-title entry**.

2. **Add amendment versions** to the `versions` array. Each version needs:

   ```json
   {
     "doc_id": "lk_acts-{slug}-amendment-{number}-{year}",
     "year": 1985,
     "date": "1985",
     "title": "{Act Name} (Amendment), No. {N} of {YYYY}",
     "doc_number": "{N}/{YYYY}",
     "is_amendment": true,
     "url_pdf": "https://..."
   }
   ```

   - Use `lk_acts-` prefixed `doc_id` for pre-2000 amendments added by research
   - Use the auto-generated `doc_id` (e.g., `2017-02-23-2017-02-23-01-2017-en`) for post-2000 amendments already in the TSV

3. **Ensure TSV rows exist** in `v2_docs.tsv` for each amendment. If missing, add them following the Source Acquisition guideline.

### Example

Health Services Act (4 amendments) and Medical Ordinance (9 amendments) are fully synced. When analyzing a new act (e.g., NMRA Act), repeat this process to add its amendments to `lineage.json`.

---

## Component Reference

All components live in `docs/src/components/` and are **reusable across ministries**.

| Component | Purpose | Data Source |
|-----------|---------|-------------|
| `StatusIndicator.tsx` | Reusable badges (status, depth, impact, confidence, kind) | N/A — props only |
| `MinistryOverview.tsx` | Filterable card grid of acts with domain coloring | `ministry-{name}-ecosystem.json` |
| `StatutoryBodiesExplorer.tsx` | Expandable cards with tabbed content | `{act}-analysis.json` |
| `AmendmentTimeline.tsx` | Vertical CSS timeline with expandable nodes | `{act}-analysis.json` |
| `EntityRelationshipView.tsx` | Governance hierarchy + OpenGIN mapping toggle | `{act}-analysis.json` |
| `MeetingsRegistry.tsx` | Searchable/filterable table of statutory body meetings | `ministry-health-meetings.json` |

### Making Components Ministry-Agnostic (Future Work)

Currently, components import their data file directly. To support multiple ministries, refactor to accept data as props:

```tsx
// Before (hardcoded):
import ecosystemData from '../data/ministry-health-ecosystem.json';

// After (prop-based):
export default function MinistryOverview({ dataPath }: { dataPath: string }) {
```

Or create wrapper components per ministry that import the right JSON and pass it down.

### Mermaid Diagram Patterns

For `act-lineage.md`, use these Mermaid diagram types:

1. **Amendment Flowchart** (`flowchart TD`) — Act → amendments, color by impact
2. **Cross-Reference Network** (`flowchart LR`) — Pairs of related acts, color by domain
3. **Governance Hierarchy** (`flowchart TD`) — Minister → bodies, color by status
4. **ER Diagram** (`erDiagram`) — Entity relationships with OpenGIN field annotations

Color conventions:
- `#1976D2` / `#90CAF9` — Low impact / informational (blue)
- `#FFA726` — Medium impact (orange)
- `#EF5350` — High impact / obsolete / superseded (red)
- `#4CAF50` — Active / positive (green)
- `#78909C` — Neutral / reporting targets (gray)
- Domain-specific colors from `domainCategories[].color`

### CSS Classes for Timeline

The timeline uses CSS classes in `docs/src/css/custom.css`:
- `.amendment-timeline` — Container with left rail
- `.timeline-node` — Individual entry
- `.timeline-node--enactment` — Blue dot
- `.timeline-node--amendment` — Orange dot
- `.timeline-node--devolution` — Red dot
- `.timeline-year` — Year label

---

## File Naming Conventions

```
docs/src/data/
  ministry-{ministry-slug}-ecosystem.json      # e.g., ministry-health-ecosystem.json
  {act-slug}-analysis.json                     # e.g., health-services-act-analysis.json

docs/docs/ministry-deep-dive/
  intro.md                                     # Section-level intro (shared)
  {ministry-slug}.mdx                          # e.g., health-ministry.mdx
  act-lineage.md                               # Visual diagrams
  {act-slug}.mdx                               # e.g., health-services-act.mdx
  data-model.md                                # Schema documentation
```

---

## Quality Checklist

Before considering a ministry deep dive complete:

- [ ] All acts from the gazette are accounted for (compare count)
- [ ] Every act has: id, title, number, year, kind, status, summary, domainCategory
- [ ] Cross-references are bidirectional (if A references B, B references A)
- [ ] Domain categories have distinct colors that work in both light/dark mode
- [ ] Mermaid color values are hex (not CSS variables — Mermaid doesn't support them)
- [ ] Deep-dive acts have: statutory bodies with all fields, amendments with section details, timeline, governance hierarchy, data confidence
- [ ] Data gaps are explicitly documented (not silently omitted)
- [ ] `analysisDepth` accurately reflects what's been researched
- [ ] Build passes with zero errors
- [ ] All internal links resolve
- [ ] Components render without console errors

---

## Example: Adding a New Ministry

Say we're adding **Ministry of Education**:

1. Research: Gather all acts from the relevant gazette, categorize into domains (Primary Education, Higher Education, Technical Training, etc.)
2. Create `docs/src/data/ministry-education-ecosystem.json`
3. Create `docs/docs/ministry-deep-dive/education-ministry.mdx` importing `<MinistryOverview />`
4. Create `docs/docs/ministry-deep-dive/education-act-lineage.md` with Mermaid diagrams
5. Update `docs/sidebars.ts`
6. If a deep dive exists (e.g., Universities Act): create analysis JSON + `.mdx` page
7. Run build, verify, done.
